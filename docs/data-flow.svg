<svg xmlns="http://www.w3.org/2000/svg" width="1360" height="760" viewBox="0 0 1360 760">
  <defs>
    <style>
      .title { font: 700 28px Arial, sans-serif; fill: #0f172a; }
      .step { font: 700 15px Arial, sans-serif; fill: #0f172a; }
      .text { font: 13px Arial, sans-serif; fill: #334155; }
      .card { fill: #f8fafc; stroke: #0f172a; stroke-width: 2; rx: 10; }
      .cardA { fill: #eef2ff; stroke: #3730a3; stroke-width: 2; rx: 10; }
      .cardB { fill: #ecfeff; stroke: #0f766e; stroke-width: 2; rx: 10; }
      .cardC { fill: #f0fdf4; stroke: #166534; stroke-width: 2; rx: 10; }
      .arrow { stroke: #0f172a; stroke-width: 2.4; marker-end: url(#arrowhead); fill: none; }
    </style>
    <marker id="arrowhead" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
      <polygon points="0 0, 10 3.5, 0 7" fill="#0f172a" />
    </marker>
  </defs>

  <rect width="1360" height="760" fill="#ffffff" />
  <text x="40" y="54" class="title">Strava Recording Quality - End-to-End Data Flow</text>

  <rect x="50" y="110" width="280" height="110" class="cardA" />
  <text x="70" y="142" class="step">1) User starts OAuth</text>
  <text x="70" y="168" class="text">GET /auth/strava/login</text>
  <text x="70" y="191" class="text">Nginx -&gt; FastAPI redirect to Strava</text>

  <rect x="390" y="110" width="280" height="110" class="cardA" />
  <text x="410" y="142" class="step">2) Strava callback</text>
  <text x="410" y="168" class="text">GET /auth/strava/callback?code=...</text>
  <text x="410" y="191" class="text">Token exchange and token persistence</text>

  <rect x="730" y="110" width="280" height="110" class="cardB" />
  <text x="750" y="142" class="step">3) Activity sync</text>
  <text x="750" y="168" class="text">POST /sync/activities</text>
  <text x="750" y="191" class="text">Paginated sync + idempotent upsert</text>

  <rect x="1070" y="110" width="240" height="110" class="cardB" />
  <text x="1090" y="142" class="step">4) Activities table</text>
  <text x="1090" y="168" class="text">Store metadata rows</text>
  <text x="1090" y="191" class="text">(user-scoped)</text>

  <rect x="50" y="320" width="280" height="120" class="cardB" />
  <text x="70" y="354" class="step">5) Stream ingest</text>
  <text x="70" y="380" class="text">POST /activities/{id}/ingest_streams</text>
  <text x="70" y="403" class="text">Fetch latlng/time/altitude streams</text>

  <rect x="390" y="320" width="280" height="120" class="cardB" />
  <text x="410" y="354" class="step">6) Point-level storage</text>
  <text x="410" y="380" class="text">Insert activity_points(seq, time_s, geom, ele_m)</text>
  <text x="410" y="403" class="text">Unique(activity_id, seq) + spatial index</text>

  <rect x="730" y="320" width="280" height="120" class="cardC" />
  <text x="750" y="354" class="step">7) Quality metrics</text>
  <text x="750" y="380" class="text">Compute distance, speed, spikes, stops, jitter</text>
  <text x="750" y="403" class="text">Persist activity_quality_metrics</text>

  <rect x="1070" y="320" width="240" height="120" class="cardC" />
  <text x="1090" y="354" class="step">8) Analytics outputs</text>
  <text x="1090" y="380" class="text">/track (GeoJSON LineString)</text>
  <text x="1090" y="403" class="text">/points.geojson + /features + /quality</text>

  <rect x="390" y="540" width="620" height="120" class="card" />
  <text x="420" y="575" class="step">Operational loop</text>
  <text x="420" y="602" class="text">JSON request logs + request_id tracing + optional Sentry + CI checks on PR/main</text>
  <text x="420" y="624" class="text">Enables reproducible debugging and interview-ready production evidence.</text>

  <path d="M330 165 L390 165" class="arrow" />
  <path d="M670 165 L730 165" class="arrow" />
  <path d="M1010 165 L1070 165" class="arrow" />
  <path d="M1190 220 L1190 320" class="arrow" />
  <path d="M1070 380 L1010 380" class="arrow" />
  <path d="M730 380 L670 380" class="arrow" />
  <path d="M390 380 L330 380" class="arrow" />
  <path d="M190 440 L190 500 L700 500 L700 540" class="arrow" />
</svg>
